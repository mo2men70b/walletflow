<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Budget Manager">
    <meta name="theme-color" content="#2d8659">
    
    <title>Budget Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #b2dfdb 50%, #80deea 100%);
            min-height: 100vh;
            padding: 8px;
            color: #2c3e50;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* Install Banner */
        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2d8659 0%, #1a5f3f 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            max-width: 90%;
            animation: slideUp 0.3s ease-out;
        }

        .install-banner.show {
            display: flex;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .install-banner-icon {
            font-size: 32px;
            flex-shrink: 0;
        }

        .install-banner-text {
            flex: 1;
        }

        .install-banner-title {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 3px;
        }

        .install-banner-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .install-banner-actions {
            display: flex;
            gap: 8px;
        }

        .install-btn {
            background: white;
            color: #2d8659;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .install-btn:hover {
            transform: scale(1.05);
        }

        .install-btn.dismiss {
            background: transparent;
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .header {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-top: 4px solid #2d8659;
        }

        .header h1 {
            font-size: 22px;
            background: linear-gradient(135deg, #2d8659 0%, #1a5f3f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
        }

        .header-subtitle {
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #e8f5e9 0%, #b2dfdb 100%);
            padding: 8px 10px;
            border-radius: 10px;
            flex: 1;
            min-width: 100%;
        }

        .btn {
            background: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #2d8659 0%, #1a5f3f 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .btn-icon {
            padding: 6px;
            min-width: 36px;
            justify-content: center;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
        }

        .btn-copy {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            font-size: 11px;
            padding: 6px 10px;
            white-space: nowrap;
        }

        .month-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: stretch;
        }

        .month-display {
            flex: 1;
            text-align: center;
        }

        .month-display-main {
            font-size: 15px;
            font-weight: bold;
            color: #1a5f3f;
        }

        .month-display-sub {
            font-size: 10px;
            color: #2d8659;
        }

        .cumulative-savings {
            background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
            color: #5a3a00;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(255,215,0,0.3);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            position: relative;
        }

        .cumulative-savings:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255,215,0,0.4);
        }

        .cumulative-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
            opacity: 0.9;
        }

        .cumulative-amount {
            font-size: 24px;
            font-weight: bold;
        }

        .reset-cumulative-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .reset-cumulative-btn:hover {
            background: #f44336;
            transform: scale(1.05);
        }

        .reset-cumulative-btn:active {
            transform: scale(0.95);
        }

        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px 0;
        }

        .chart-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }

        .legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 8px;
        }

        .legend-label {
            display: flex;
            align-items: center;
            flex: 1;
            font-size: 13px;
            font-weight: 500;
        }

        .legend-value {
            font-size: 13px;
            font-weight: 700;
        }

        .legend-percentage {
            font-size: 11px;
            color: #666;
            margin-left: 5px;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .summary-card {
            background: white;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #ccc;
        }

        .summary-card.income {
            border-left-color: #4caf50;
        }

        .summary-card.expenses {
            border-left-color: #f44336;
        }

        .summary-card.savings {
            border-left-color: #2196f3;
        }

        .summary-card.balance-positive {
            border-left-color: #ffd700;
        }

        .summary-card.balance-negative {
            border-left-color: #ff5722;
        }

        .summary-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .summary-amount {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-total {
            font-size: 15px;
            font-weight: bold;
        }

        .section-total.income {
            color: #4caf50;
        }

        .section-total.expenses {
            color: #f44336;
        }

        .section-total.savings {
            color: #2196f3;
        }

        .items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 6px;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .item-name {
            font-size: 13px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-name.editing {
            background: white;
            border: 2px solid #2d8659;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 13px;
            width: 100%;
        }

        .item-amount {
            width: 70px;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            text-align: right;
        }

        .item-currency {
            font-size: 11px;
            color: #666;
            font-weight: 600;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .icon-btn.delete:hover {
            background: rgba(244, 67, 54, 0.1);
        }

        .icon {
            display: inline-block;
            width: 18px;
            height: 18px;
        }

        /* Icons using Unicode */
        .icon-plus::before { content: "‚ûï"; font-size: 14px; }
        .icon-edit::before { content: "‚úèÔ∏è"; font-size: 14px; }
        .icon-check::before { content: "‚úÖ"; font-size: 14px; }
        .icon-trash::before { content: "üóëÔ∏è"; font-size: 14px; }
        .icon-left::before { content: "‚óÄ"; font-size: 14px; }
        .icon-right::before { content: "‚ñ∂"; font-size: 14px; }
        .icon-pdf::before { content: "üìÑ"; font-size: 14px; }
        .icon-piggy::before { content: "üê∑"; font-size: 18px; }
        .icon-chart::before { content: "üìä"; font-size: 18px; }
        .icon-trophy::before { content: "üèÜ"; font-size: 18px; }
        .icon-reset::before { content: "üîÑ"; font-size: 11px; }
        .icon-copy::before { content: "üìã"; font-size: 12px; }

        .add-item-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 6px;
            margin-top: 10px;
        }

        .add-item-input {
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
        }

        .add-item-input:focus {
            outline: none;
            border-color: #2d8659;
        }

        /* Savings Breakdown */
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }

        .breakdown-label {
            font-weight: 500;
        }

        .breakdown-amount {
            font-weight: 600;
            color: #2196f3;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 20px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #2d8659;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .month-summary {
            margin-bottom: 12px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            border-left: 4px solid #ffd700;
        }

        .month-summary-header {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .month-summary-amount {
            font-size: 16px;
            font-weight: bold;
            color: #2d8659;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #2d8659;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1002;
            font-size: 13px;
            font-weight: 600;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Print Styles - FIT EVERYTHING ON ONE PAGE */
        @media print {
            @page {
                size: A4 portrait;
                margin: 8mm;
            }

            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            body {
                background: white !important;
                padding: 0 !important;
                font-size: 7px !important;
            }

            .container {
                max-width: 100% !important;
            }

            .header-actions,
            .add-item-form,
            .icon-btn,
            .install-banner,
            .month-display-sub,
            .btn,
            .reset-cumulative-btn {
                display: none !important;
            }

            .header {
                padding: 4px !important;
                margin-bottom: 4px !important;
                page-break-inside: avoid !important;
            }

            .header h1 {
                font-size: 12px !important;
                margin-bottom: 2px !important;
            }

            .header-subtitle {
                font-size: 7px !important;
            }

            .cumulative-savings {
                padding: 4px 8px !important;
                margin-bottom: 4px !important;
                page-break-inside: avoid !important;
            }

            .cumulative-label {
                font-size: 6px !important;
                margin-bottom: 2px !important;
            }

            .cumulative-amount {
                font-size: 10px !important;
            }

            .chart-section {
                padding: 4px !important;
                margin-bottom: 4px !important;
                page-break-inside: avoid !important;
            }

            .section-title {
                font-size: 8px !important;
            }

            .chart-container {
                padding: 2px 0 !important;
            }

            #pieChart {
                width: 100px !important;
                height: 100px !important;
            }

            .chart-legend {
                gap: 2px !important;
                margin-top: 4px !important;
                padding-top: 4px !important;
            }

            .legend-item {
                padding: 3px !important;
            }

            .legend-color {
                width: 10px !important;
                height: 10px !important;
                margin-right: 4px !important;
            }

            .legend-label {
                font-size: 7px !important;
            }

            .legend-value {
                font-size: 7px !important;
            }

            .legend-percentage {
                font-size: 6px !important;
                margin-left: 2px !important;
            }

            .summary {
                gap: 3px !important;
                margin-bottom: 4px !important;
                page-break-inside: avoid !important;
            }

            .summary-card {
                padding: 3px !important;
            }

            .summary-label {
                font-size: 6px !important;
                margin-bottom: 1px !important;
            }

            .summary-amount {
                font-size: 9px !important;
            }

            .section {
                padding: 4px !important;
                margin-bottom: 4px !important;
                page-break-inside: avoid !important;
            }

            .section-header {
                margin-bottom: 3px !important;
                padding-bottom: 2px !important;
            }

            .section-title {
                font-size: 8px !important;
            }

            .section-total {
                font-size: 8px !important;
            }

            .items {
                gap: 2px !important;
            }

            .item {
                padding: 2px 4px !important;
                grid-template-columns: 1fr auto auto !important;
                gap: 3px !important;
            }

            .item-name {
                font-size: 7px !important;
            }

            .item-amount {
                width: auto !important;
                padding: 1px 3px !important;
                font-size: 7px !important;
                border: none !important;
                background: transparent !important;
            }

            .item-currency {
                font-size: 6px !important;
            }

            .breakdown-item {
                padding: 2px 0 !important;
                font-size: 7px !important;
            }

            .print-footer {
                display: block !important;
                text-align: center !important;
                font-size: 6px !important;
                color: #666 !important;
                margin-top: 4px !important;
                padding-top: 3px !important;
                border-top: 1px solid #ddd !important;
                page-break-inside: avoid !important;
            }

            .modal,
            .toast {
                display: none !important;
            }
        }

        .print-footer {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Install Banner -->
        <div class="install-banner" id="installBanner">
            <div class="install-banner-icon">üì±</div>
            <div class="install-banner-text">
                <div class="install-banner-title">Install Budget Manager</div>
                <div class="install-banner-subtitle">Add to home screen for offline access</div>
            </div>
            <div class="install-banner-actions">
                <button class="install-btn" onclick="installApp()">Install</button>
                <button class="install-btn dismiss" onclick="dismissInstall()">Later</button>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>üí∞ WalletFlow</h1>
            <div class="header-subtitle">Track your monthly finances</div>
            
            <div class="header-actions">
                <div class="month-nav">
                    <button class="btn btn-icon" onclick="previousMonth()">
                        <span class="icon icon-left"></span>
                    </button>
                    <div class="month-display">
                        <div class="month-display-main" id="currentMonth"></div>
                        <div class="month-display-sub">Swipe or use arrows</div>
                    </div>
                    <div class="month-actions">
                        <button class="btn btn-icon" onclick="nextMonth()">
                            <span class="icon icon-right"></span>
                        </button>
                        <button class="btn btn-copy btn-small" onclick="copyFromPreviousMonth()">
                            <span class="icon icon-copy"></span>
                            Copy Previous
                        </button>
                    </div>
                </div>
                <button class="btn btn-primary btn-small" onclick="exportToPDF()">
                    <span class="icon icon-pdf"></span>
                    Export PDF
                </button>
            </div>
        </div>

        <!-- Cumulative Savings with Reset -->
        <div class="cumulative-savings" onclick="event.target === this ? showCumulativeModal() : null">
            <button class="reset-cumulative-btn" onclick="handleResetClick(event)">
                <span class="icon icon-reset"></span> Reset
            </button>
            <div class="cumulative-label">
                <span class="icon icon-piggy"></span>
                Total Cumulative Savings
            </div>
            <div class="cumulative-amount" id="cumulativeSavings">KWD 0.00</div>
        </div>

        <!-- Pie Chart with Percentages -->
        <div class="chart-section">
            <div class="section-title">
                <span class="icon icon-chart"></span>
                Budget Overview
            </div>
            <div class="chart-container">
                <canvas id="pieChart" width="250" height="250"></canvas>
            </div>
            
            <!-- Category Percentages -->
            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-label">
                        <div class="legend-color" style="background: #f44336;"></div>
                        Expenses
                    </div>
                    <div class="legend-value">
                        <span id="expensesAmount">KWD 0.00</span>
                        <span class="legend-percentage" id="expensesPercent">(0%)</span>
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">
                        <div class="legend-color" style="background: #2196f3;"></div>
                        Savings
                    </div>
                    <div class="legend-value">
                        <span id="savingsAmount">KWD 0.00</span>
                        <span class="legend-percentage" id="savingsPercent">(0%)</span>
                    </div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">
                        <div class="legend-color" style="background: #4caf50;"></div>
                        Available
                    </div>
                    <div class="legend-value">
                        <span id="availableAmount">KWD 0.00</span>
                        <span class="legend-percentage" id="availablePercent">(0%)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary">
            <div class="summary-card income">
                <div class="summary-label">Income</div>
                <div class="summary-amount" id="totalIncome">KWD 0.00</div>
            </div>
            <div class="summary-card expenses">
                <div class="summary-label">Expenses</div>
                <div class="summary-amount" id="totalExpenses">KWD 0.00</div>
            </div>
            <div class="summary-card savings">
                <div class="summary-label">Savings</div>
                <div class="summary-amount" id="totalSavings">KWD 0.00</div>
            </div>
            <div class="summary-card balance-positive" id="balanceCard">
                <div class="summary-label">Cash Balance</div>
                <div class="summary-amount" id="cashBalance">KWD 0.00</div>
            </div>
        </div>

        <!-- Income Section -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">üíµ Income</div>
                <div class="section-total income" id="incomeTotal">KWD 0.00</div>
            </div>
            <div class="items" id="incomeItems"></div>
            <div class="add-item-form">
                <input type="text" class="add-item-input" id="newIncomeName" placeholder="Add income source...">
                <button class="btn btn-primary btn-icon" onclick="addItem('income')">
                    <span class="icon icon-plus"></span>
                </button>
            </div>
        </div>

        <!-- Expenses Section -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">üí≥ Expenses</div>
                <div class="section-total expenses" id="expensesTotal">KWD 0.00</div>
            </div>
            <div class="items" id="expensesItems"></div>
            <div class="add-item-form">
                <input type="text" class="add-item-input" id="newExpensesName" placeholder="Add expense...">
                <button class="btn btn-primary btn-icon" onclick="addItem('expenses')">
                    <span class="icon icon-plus"></span>
                </button>
            </div>
        </div>

        <!-- Savings Section -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">üí∞ Savings Allocation</div>
                <div class="section-total savings" id="savingsTotal">KWD 0.00</div>
            </div>
            <div class="items" id="savingsItems"></div>
            <div class="add-item-form">
                <input type="text" class="add-item-input" id="newSavingsName" placeholder="Add savings goal...">
                <button class="btn btn-primary btn-icon" onclick="addItem('savings')">
                    <span class="icon icon-plus"></span>
                </button>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 13px;">Savings Breakdown</div>
                <div id="savingsBreakdown"></div>
            </div>
        </div>

        <div class="print-footer">
            Generated on <span id="printDate"></span> | Budget Manager App
        </div>
    </div>

    <!-- Cumulative Savings Modal -->
    <div class="modal" id="cumulativeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="icon icon-trophy"></span>
                    Cumulative Savings History
                </div>
                <button class="close-btn" onclick="closeCumulativeModal()">√ó</button>
            </div>
            <div id="cumulativeDetails"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Generate icon
        function generatePNGIcon(size) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            const gradient = ctx.createLinearGradient(0, 0, size, size);
            gradient.addColorStop(0, '#2d8659');
            gradient.addColorStop(1, '#1a5f3f');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.beginPath();
            ctx.arc(size/2, size/2, size * 0.4, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#ffffff';
            ctx.font = `bold ${size * 0.6}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('$', size/2, size/2);

            return canvas.toDataURL('image/png');
        }

        // PWA Setup
        function setupPWA() {
            console.log('üîß Setting up PWA...');
            
            const icon192 = generatePNGIcon(192);
            const icon512 = generatePNGIcon(512);

            // Get the current path for proper PWA installation
            const currentPath = window.location.pathname;
            const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
            
            const manifest = {
                name: "WalletFlow - Budget Manager",
                short_name: "WalletFlow",
                description: "Track your monthly income, expenses and savings",
                start_url: basePath,
                scope: basePath,
                display: "standalone",
                background_color: "#e8f5e9",
                theme_color: "#2d8659",
                orientation: "portrait-primary",
                icons: [
                    {
                        src: icon192,
                        sizes: "192x192",
                        type: "image/png",
                        purpose: "any"
                    },
                    {
                        src: icon512,
                        sizes: "512x512",
                        type: "image/png",
                        purpose: "any"
                    },
                    {
                        src: icon192,
                        sizes: "192x192",
                        type: "image/png",
                        purpose: "maskable"
                    },
                    {
                        src: icon512,
                        sizes: "512x512",
                        type: "image/png",
                        purpose: "maskable"
                    }
                ]
            };

            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(manifestBlob);
            
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = manifestURL;
            document.head.appendChild(manifestLink);

            const favicon = document.createElement('link');
            favicon.rel = 'icon';
            favicon.type = 'image/png';
            favicon.href = icon192;
            document.head.appendChild(favicon);

            const appleTouchIcon = document.createElement('link');
            appleTouchIcon.rel = 'apple-touch-icon';
            appleTouchIcon.href = icon512;
            document.head.appendChild(appleTouchIcon);

            registerServiceWorker();
        }

        function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.log('‚ùå Service Worker not supported');
                return;
            }

            const swCode = `
                const CACHE_NAME = 'walletflow-v3';
                const urlsToCache = [
                    './',
                    './index.html'
                ];
                
                self.addEventListener('install', (e) => { 
                    console.log('[SW] Installing...');
                    e.waitUntil(
                        caches.open(CACHE_NAME).then(cache => {
                            console.log('[SW] Caching files');
                            return cache.addAll(urlsToCache).catch(err => {
                                console.log('[SW] Cache failed:', err);
                            });
                        })
                    );
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', (e) => { 
                    console.log('[SW] Activating...');
                    e.waitUntil(
                        caches.keys().then(keys => {
                            return Promise.all(
                                keys.filter(key => key !== CACHE_NAME)
                                    .map(key => caches.delete(key))
                            );
                        }).then(() => self.clients.claim())
                    ); 
                });
                
                self.addEventListener('fetch', (e) => {
                    e.respondWith(
                        caches.match(e.request).then(response => {
                            if (response) {
                                return response;
                            }
                            return fetch(e.request).then(fetchResponse => {
                                if (!fetchResponse || fetchResponse.status !== 200 || fetchResponse.type !== 'basic') {
                                    return fetchResponse;
                                }
                                const responseToCache = fetchResponse.clone();
                                caches.open(CACHE_NAME).then(cache => {
                                    cache.put(e.request, responseToCache);
                                });
                                return fetchResponse;
                            });
                        }).catch(() => {
                            console.log('[SW] Fetch failed, offline mode');
                        })
                    );
                });
            `;

            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swURL = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swURL)
                .then(r => {
                    console.log('‚úÖ SW registered:', r);
                    return navigator.serviceWorker.ready;
                })
                .then(() => {
                    console.log('‚úÖ SW ready');
                })
                .catch(e => console.log('‚ùå SW failed:', e));
        }

        let deferredPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                if (!localStorage.getItem('installDismissed') && !isRunningStandalone()) {
                    document.getElementById('installBanner').classList.add('show');
                }
            }, 3000);
        });

        async function installApp() {
            if (!deferredPrompt) {
                showToast('Use Chrome menu ‚Üí "Install app"');
                return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                showToast('Installing... üéâ');
                document.getElementById('installBanner').classList.remove('show');
            }
            deferredPrompt = null;
        }

        function dismissInstall() {
            document.getElementById('installBanner').classList.remove('show');
            localStorage.setItem('installDismissed', 'true');
        }

        function isRunningStandalone() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true;
        }

        // Budget Manager Logic
        let budgets = {};
        let currentMonth = new Date().toISOString().slice(0, 7);
        let editingItem = null;

        function init() {
            console.log('üöÄ Initializing WalletFlow...');
            
            // Check if running in standalone mode
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            console.log('üì± Running in standalone mode:', isStandalone);
            
            if (isStandalone) {
                console.log('‚úÖ PWA is installed and running standalone!');
            } else {
                console.log('üåê Running in browser mode');
            }
            
            setupPWA();
            loadFromStorage();
            render();
        }

        function loadFromStorage() {
            const stored = localStorage.getItem('budgetData');
            if (stored) {
                try {
                    budgets = JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to load data:', e);
                    budgets = {};
                }
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('budgetData', JSON.stringify(budgets));
                console.log('üíæ Data saved');
            } catch (e) {
                console.error('Failed to save:', e);
                showToast('Failed to save data!');
            }
        }

        function getCurrentBudget() {
            if (!budgets[currentMonth]) {
                budgets[currentMonth] = {
                    income: [],
                    expenses: [],
                    savings: []
                };
            }
            return budgets[currentMonth];
        }

        function nextMonth() {
            const date = new Date(currentMonth + '-01');
            date.setMonth(date.getMonth() + 1);
            currentMonth = date.toISOString().slice(0, 7);
            render();
        }

        function previousMonth() {
            const date = new Date(currentMonth + '-01');
            date.setMonth(date.getMonth() - 1);
            currentMonth = date.toISOString().slice(0, 7);
            render();
        }

        function copyFromPreviousMonth() {
            console.log('üìã Copying from previous month...');
            
            // Get previous month key
            const date = new Date(currentMonth + '-01');
            date.setMonth(date.getMonth() - 1);
            const previousMonthKey = date.toISOString().slice(0, 7);
            
            // Check if previous month has data
            if (!budgets[previousMonthKey]) {
                showToast('No data in previous month!');
                console.log('‚ùå No previous month data found');
                return;
            }
            
            const previousBudget = budgets[previousMonthKey];
            const currentBudget = getCurrentBudget();
            
            // Count items to copy
            let itemCount = 0;
            
            // Copy income items (deep clone)
            if (previousBudget.income && previousBudget.income.length > 0) {
                currentBudget.income = previousBudget.income.map(item => ({
                    name: item.name,
                    amount: item.amount
                }));
                itemCount += previousBudget.income.length;
            }
            
            // Copy expenses items (deep clone)
            if (previousBudget.expenses && previousBudget.expenses.length > 0) {
                currentBudget.expenses = previousBudget.expenses.map(item => ({
                    name: item.name,
                    amount: item.amount
                }));
                itemCount += previousBudget.expenses.length;
            }
            
            // Copy savings items (deep clone)
            if (previousBudget.savings && previousBudget.savings.length > 0) {
                currentBudget.savings = previousBudget.savings.map(item => ({
                    name: item.name,
                    amount: item.amount
                }));
                itemCount += previousBudget.savings.length;
            }
            
            // Save and render
            saveToStorage();
            render();
            
            const prevDate = new Date(previousMonthKey + '-01');
            const prevMonthName = prevDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            showToast(`‚úÖ Copied ${itemCount} items from ${prevMonthName}!`);
            console.log(`‚úÖ Copied ${itemCount} items from ${prevMonthName}`);
        }

        function addItem(section) {
            const input = document.getElementById(`new${section.charAt(0).toUpperCase() + section.slice(1)}Name`);
            const name = input.value.trim();
            
            if (!name) {
                showToast('Please enter a name');
                return;
            }

            const budget = getCurrentBudget();
            budget[section].push({ name, amount: 0 });
            
            input.value = '';
            saveToStorage();
            render();
            showToast(`${name} added!`);
        }

        function removeItem(section, index) {
            const budget = getCurrentBudget();
            const itemName = budget[section][index].name;
            budget[section].splice(index, 1);
            saveToStorage();
            render();
            showToast(`${itemName} removed`);
        }

        function updateItem(section, index, field, value) {
            const budget = getCurrentBudget();
            if (field === 'amount') {
                budget[section][index][field] = parseFloat(value) || 0;
            } else {
                budget[section][index][field] = value;
            }
            saveToStorage();
            render();
        }

        function toggleEdit(section, index) {
            editingItem = editingItem === `${section}-${index}` ? null : `${section}-${index}`;
            render();
        }

        function calculateTotals(budget) {
            const totalIncome = budget.income.reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = budget.expenses.reduce((sum, item) => sum + item.amount, 0);
            const totalSavings = budget.savings.reduce((sum, item) => sum + item.amount, 0);
            const cashBalance = totalIncome - totalExpenses - totalSavings;
            return { totalIncome, totalExpenses, totalSavings, cashBalance };
        }

        function calculateCumulativeSavings() {
            let total = 0;
            for (const month in budgets) {
                const totals = calculateTotals(budgets[month]);
                total += totals.totalSavings;
            }
            return total;
        }

        // FIXED: Reset button handler
        function handleResetClick(event) {
            event.stopPropagation();
            event.preventDefault();
            console.log('üîÑ Reset button clicked');
            resetCumulativeSavings();
        }

        function resetCumulativeSavings() {
            console.log('üîÑ Resetting cumulative savings...');
            
            if (!confirm('Reset all savings amounts to 0?\n\n‚úì Keeps income & expenses\n‚úó Resets all savings to 0')) {
                console.log('‚ùå Reset cancelled');
                return;
            }

            let resetCount = 0;
            for (const month in budgets) {
                if (budgets[month].savings && budgets[month].savings.length > 0) {
                    budgets[month].savings.forEach(item => {
                        if (item.amount !== 0) {
                            item.amount = 0;
                            resetCount++;
                        }
                    });
                }
            }
            
            saveToStorage();
            render();
            showToast(`‚úÖ Reset complete! ${resetCount} savings reset to 0`);
            console.log(`‚úÖ Reset ${resetCount} savings items`);
        }

        function drawPieChart(income, expenses, savings) {
            const canvas = document.getElementById('pieChart');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 100;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const total = income || 1;
            const available = Math.max(0, income - expenses - savings);
            
            const expensesAngle = (expenses / total) * 2 * Math.PI;
            const savingsAngle = (savings / total) * 2 * Math.PI;

            let currentAngle = -Math.PI / 2;

            if (expenses > 0) {
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + expensesAngle);
                ctx.closePath();
                ctx.fillStyle = '#f44336';
                ctx.fill();
                currentAngle += expensesAngle;
            }

            if (savings > 0) {
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + savingsAngle);
                ctx.closePath();
                ctx.fillStyle = '#2196f3';
                ctx.fill();
                currentAngle += savingsAngle;
            }

            if (available > 0) {
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, -Math.PI / 2);
                ctx.closePath();
                ctx.fillStyle = '#4caf50';
                ctx.fill();
            }

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.6, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();

            if (income > 0) {
                const expensesPercent = ((expenses / income) * 100).toFixed(1);
                const savingsPercent = ((savings / income) * 100).toFixed(1);
                const availablePercent = ((available / income) * 100).toFixed(1);

                document.getElementById('expensesAmount').textContent = `KWD ${expenses.toFixed(2)}`;
                document.getElementById('expensesPercent').textContent = `(${expensesPercent}%)`;
                document.getElementById('savingsAmount').textContent = `KWD ${savings.toFixed(2)}`;
                document.getElementById('savingsPercent').textContent = `(${savingsPercent}%)`;
                document.getElementById('availableAmount').textContent = `KWD ${available.toFixed(2)}`;
                document.getElementById('availablePercent').textContent = `(${availablePercent}%)`;
            } else {
                document.getElementById('expensesAmount').textContent = 'KWD 0.00';
                document.getElementById('expensesPercent').textContent = '(0%)';
                document.getElementById('savingsAmount').textContent = 'KWD 0.00';
                document.getElementById('savingsPercent').textContent = '(0%)';
                document.getElementById('availableAmount').textContent = 'KWD 0.00';
                document.getElementById('availablePercent').textContent = '(0%)';
            }
        }

        function showCumulativeModal() {
            const modal = document.getElementById('cumulativeModal');
            const details = document.getElementById('cumulativeDetails');
            
            let html = '';
            const sortedMonths = Object.keys(budgets).sort().reverse();
            
            if (sortedMonths.length === 0) {
                html = '<p style="text-align: center; color: #999;">No data yet</p>';
            } else {
                sortedMonths.forEach(month => {
                    const totals = calculateTotals(budgets[month]);
                    const date = new Date(month + '-01');
                    const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    
                    html += `
                        <div class="month-summary">
                            <div class="month-summary-header">${monthName}</div>
                            <div class="month-summary-amount">KWD ${totals.totalSavings.toFixed(2)}</div>
                        </div>
                    `;
                });
            }
            
            details.innerHTML = html;
            modal.classList.add('show');
        }

        function closeCumulativeModal() {
            document.getElementById('cumulativeModal').classList.remove('show');
        }

        function renderItems(section, items) {
            if (items.length === 0) {
                return '<p style="text-align: center; color: #999; font-size: 12px;">No items yet</p>';
            }

            return items.map((item, index) => {
                const isEditing = editingItem === `${section}-${index}`;
                return `
                    <div class="item">
                        ${isEditing ? `
                            <input 
                                type="text" 
                                class="item-name editing" 
                                value="${item.name}"
                                onblur="updateItem('${section}', ${index}, 'name', this.value); toggleEdit('${section}', ${index})"
                                onkeypress="if(event.key==='Enter') this.blur()"
                                autofocus
                            />
                            <button class="icon-btn" onclick="toggleEdit('${section}', ${index})">
                                <span class="icon icon-check"></span>
                            </button>
                        ` : `
                            <div class="item-name">${item.name}</div>
                            <button class="icon-btn" onclick="toggleEdit('${section}', ${index})">
                                <span class="icon icon-edit"></span>
                            </button>
                        `}
                        <input 
                            type="number" 
                            class="item-amount" 
                            value="${item.amount}"
                            step="0.01"
                            onchange="updateItem('${section}', ${index}, 'amount', this.value)"
                        />
                        <span class="item-currency">KWD</span>
                        <button class="icon-btn delete" onclick="removeItem('${section}', ${index})">
                            <span class="icon icon-trash"></span>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderSavingsBreakdown(savings) {
            const total = savings.reduce((sum, item) => sum + item.amount, 0);
            if (total === 0) return '<p style="font-size: 12px; color: #999; text-align: center;">No savings this month</p>';

            return savings.map(item => {
                if (item.amount === 0) return '';
                const percentage = ((item.amount / total) * 100).toFixed(1);
                return `
                    <div class="breakdown-item">
                        <span class="breakdown-label">${item.name}</span>
                        <span class="breakdown-amount">KWD ${item.amount.toFixed(2)} (${percentage}%)</span>
                    </div>
                `;
            }).join('');
        }

        function render() {
            const budget = getCurrentBudget();
            const totals = calculateTotals(budget);
            const cumulativeSavings = calculateCumulativeSavings();
            
            const date = new Date(currentMonth + '-01');
            document.getElementById('currentMonth').textContent = 
                date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            document.getElementById('cumulativeSavings').textContent = `KWD ${cumulativeSavings.toFixed(2)}`;
            
            drawPieChart(totals.totalIncome, totals.totalExpenses, totals.totalSavings);
            
            document.getElementById('totalIncome').textContent = `KWD ${totals.totalIncome.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `KWD ${totals.totalExpenses.toFixed(2)}`;
            document.getElementById('totalSavings').textContent = `KWD ${totals.totalSavings.toFixed(2)}`;
            document.getElementById('cashBalance').textContent = `KWD ${totals.cashBalance.toFixed(2)}`;
            
            const balanceCard = document.getElementById('balanceCard');
            balanceCard.className = totals.cashBalance >= 0 ? 
                'summary-card balance-positive' : 'summary-card balance-negative';
            
            document.getElementById('incomeItems').innerHTML = renderItems('income', budget.income);
            document.getElementById('expensesItems').innerHTML = renderItems('expenses', budget.expenses);
            document.getElementById('savingsItems').innerHTML = renderItems('savings', budget.savings);
            
            document.getElementById('incomeTotal').textContent = `KWD ${totals.totalIncome.toFixed(2)}`;
            document.getElementById('expensesTotal').textContent = `KWD ${totals.totalExpenses.toFixed(2)}`;
            document.getElementById('savingsTotal').textContent = `KWD ${totals.totalSavings.toFixed(2)}`;
            
            document.getElementById('savingsBreakdown').innerHTML = renderSavingsBreakdown(budget.savings);
        }

        // FIXED: PDF Export
        function exportToPDF() {
            console.log('üìÑ Exporting to PDF...');
            
            const today = new Date().toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('printDate').textContent = today;
            
            showToast('Opening print dialog...');
            
            // Small delay to ensure toast shows
            setTimeout(() => {
                try {
                    window.print();
                    console.log('‚úÖ Print dialog opened');
                } catch (e) {
                    console.error('‚ùå Print failed:', e);
                    showToast('Print failed! Try again.');
                }
            }, 300);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.remove('show');
            
            // Force reflow
            void toast.offsetWidth;
            
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // Event listeners
        window.onload = init;

        document.addEventListener('click', function(event) {
            const modal = document.getElementById('cumulativeModal');
            if (event.target === modal) {
                closeCumulativeModal();
            }
        });

        window.addEventListener('appinstalled', () => {
            showToast('App installed! üéâ');
        });

        console.log('üéØ Budget Manager Ready');
    </script>
</body>
</html>
